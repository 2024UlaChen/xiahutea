<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的訂單</title>

    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="assets/css/animate.min.css">
    <link rel="stylesheet" href="assets/css/jquery-ui.css">
    <link rel="stylesheet" href="assets/css/slick.css">
    <link rel="stylesheet" href="assets/css/chosen.min.css">
    <link rel="stylesheet" href="assets/css/pe-icon-7-stroke.css">
    <link rel="stylesheet" href="assets/css/magnific-popup.min.css">
    <link rel="stylesheet" href="assets/css/lightbox.min.css">
    <link rel="stylesheet" href="assets/js/fancybox/source/jquery.fancybox.css">
    <link rel="stylesheet" href="assets/css/jquery.scrollbar.min.css">
    <link rel="stylesheet" href="assets/css/mobile-menu.css">
    <link rel="stylesheet" href="assets/fonts/flaticon/flaticon.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="css/general.css">

    <style>
        /* main區塊 */
        .left-sidebar .content-area{
            float: left;
            width: 100%;
        }
        .shop-top-control{
            width: 100%;
            margin-top: 10px;
            border-radius: 5px;
        }

        /* 查詢欄 */
        /*  select訂單狀態*/
        input[type="text"], input[type="email"], input[type="password"], input[type="tel"], input[type="search"], input[type="url"], textarea, select{
            background-color: white;
            height: 40px;
            width: 200px;
            color: black;
            border-radius: 5px;
            border: 1px solid #DFF3F7;
        }
        input.select_date{
            width: 150px;
            font-weight: normal;
            text-align: center;
            height: 40px;
            color: black;
            border-radius: 5px;
            border: 1px solid #DFF3F7;
        }
        span.title{
            margin: 20px;
            color: black;
        }

        /* 查詢btn */
        #select_btn{
            width: 100px;
            height: 40px;
            background-color: #F8F9FA;
            border: 1px solid #73B4BA;
            line-height: 20px;
            font-size: 16px;
            color: #53a0a7;
            border-radius: 5px;
        }

        /* 分頁 */
        #page_div {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        /* 上下頁 */
        .page_btn {
            margin-top: 8px;
            width: 100px;
            height: 40px;
            color: #53a0a7;
            font-weight: bold;
            text-align: center;
            line-height: 20px;
            font-size: 16px;
            background-color: white;
            border: 1px solid #73B4BA;
            border-radius: 5px;
        }
        /* 頁數 */
        .page-button {
            margin-top: 8px;
            width: 30px;
            height: 40px;
            color: #53a0a7;
            text-align: center;
            line-height: 20px;
            background-color: white;
            border: 1px solid #73B4BA;
            border-radius: 4px;
        }
        #page_text{
            text-align: center;
        }

        /* 訂單區塊*/
        .product-item .product-inner {
            border-radius: 20px;
            box-shadow: 0 0 2px 0 #c6c6c6;
        }
        div.one_order_list{
            border-bottom: 1px #e4e4e48e solid;
            width: 100%;
            height: 200px;
        }
        div.one_order_list_circle{
            display: inline-block;
            margin-top: 50px;
            width: 100px;
            height: 100px;
            line-height:180px ;
            border-radius: 50%;
            overflow: hidden;
        }
        img.store_logo{
            object-fit:cover;
            width: 100%;
            height: 100%;
            vertical-align:baseline ;
        }
        div.one_order_store_name span{
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            line-height: 2;
            color: black;
        }
        div.order_detail>span{
            color: black;
            font-size: 14px;
        }
        div.order_price>span{
            color: black;
            font-size: 18px;
            font-weight: bold;
        }
        div.order_time>span, .dispute_text{
            color: black;
            font-size: 12px;
            line-height: 2;
        }
        ul.order_list_ul{
            display:  inline;
        }
        .left-sidebar .content-area{
            float: left;
            width: 100%;
        }
        span.title{
            margin: 20px;
        }
        .order_id{
            display: none;
        }

        .one_order_status{
            width: 100%;
            height:100px;
        }
        span.one_order_status_text{
            font-size: 28px;
            color: white;
            font-weight: bold;
            text-align: center;
            line-height:100px ;
        }

        /* 訂單狀態 更改css */
        div.one_order_status.incomplete{
            background-color: #FAC792;
        }
        div.one_order_status.complete{
            background-color: #73B4BA;
        }
        div.one_order_status.cancel{
            background-color: #9c9c9c;
        }
    </style>
</head>

<body>
<div class="header"></div>
<div class="main-content main-content-product left-sidebar">
    <div class="container">
        <div class="row">
            <div class="content-area shop-grid-content no-banner col-lg-9 col-md-9 col-sm-12 col-xs-12">
                <div class="site-main" style="width: 100%">
                    <!-- 查詢區塊 -->
                    <div class="shop-top-control">
                        <form class="select-item select-form" >
                            <span class="title">訂單日期</span>
                            <label>
                                <input class="select_date" type="date">
                            </label>
                            <span> ~ </span>
                            <label>
                                <input class="select_date" type="date">
                            </label>
                        </form>
                        <form class="select-item select-form" >
                            <button  id="select_btn">查詢</button>
                        </form>
                    </div>
                    <!-- 訂單區塊 -->
                    <ul class="row list-products auto-clear equal-container product-grid order_list_ul">
                    <!--  JS放入訂單資料  -->
                    </ul>
                    <div id="page_div">
                        <button id="previous" class="btn btn-block btn-default page_btn">上一頁</button>
                        <span id="pagination"></span>
                        <button id="next" class="btn btn-block btn-default page_btn">下一頁</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer"></div>

<script src="assets/js/jquery-1.12.4.min.js"></script>
<script src="assets/js/jquery.plugin-countdown.min.js"></script>
<script src="assets/js/jquery-countdown.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/owl.carousel.min.js"></script>
<script src="assets/js/magnific-popup.min.js"></script>
<script src="assets/js/isotope.min.js"></script>
<script src="assets/js/jquery.scrollbar.min.js"></script>
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/mobile-menu.js"></script>
<script src="assets/js/chosen.min.js"></script>
<script src="assets/js/slick.js"></script>
<script src="assets/js/jquery.elevateZoom.min.js"></script>
<script src="assets/js/jquery.actual.min.js"></script>
<script src="assets/js/fancybox/source/jquery.fancybox.js"></script>
<script src="assets/js/lightbox.min.js"></script>
<script src="assets/js/owl.thumbs.min.js"></script>
<script src="assets/js/jquery.scrollbar.min.js"></script>
<script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyC3nDHy1dARR-Pa_2jjPCjvsOR4bcILYsM'></script>
<script src="assets/js/frontend-plugin.js"></script>
<script src="./js/general.js"></script>
<!-- sweet alert  -->
<script src="cms/plugins/sweetalert2/sweetalert2.all.js"></script>

<script>
    const size = 9;                 // 每頁顯示的筆數
    let totalPages = 0;             // 總頁數
    let currentPage = 0;            // 當前頁數
    let selectedDateStart = "";     // 選擇的開始日期
    let selectedDateEnd = "";       // 選擇的結束日期
    let dateRangeApplied = false;   // 是否已選擇日期範圍

    // 取得sessionStorage會員ID
    const memberData = sessionStorage.getItem("memberData") ? JSON.parse(sessionStorage.getItem("memberData")) : null;
    const customerId = memberData && memberData.data ? memberData.data.customerId : null;

    document.addEventListener("DOMContentLoaded", function(){
        // 判斷權限
        if(!(customerId)){
            Swal.fire({
                title: "請登入會員",
                text: '',
                icon: 'error',
                showConfirmButton: true  // 確認按鈕
            }).then(() => {
                location.href = "./login.html";
            });
        }
        // 如果是會員才能檢視
        init(currentPage, size, customerId);
        //-----------------------------------------------------------------------
        // btn 上下頁
        const nextButton = document.getElementById("next");
        const previousButton = document.getElementById("previous");
        if (nextButton) {
            nextButton.addEventListener("click", function () {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    let selectOrderDate1El = document.getElementsByClassName("select_date")[0];
                    let selectOrderDate2El = document.getElementsByClassName("select_date")[1];
                    let selectOrderDate1 = selectOrderDate1El.value || "";
                    let selectOrderDate2 = selectOrderDate2El.value || "";

                    // 依查詢條件載入訂單
                    init(currentPage, size, customerId, selectOrderDate1, selectOrderDate2);
                }
            });
        }
        if (previousButton) {
            previousButton.addEventListener("click", function () {
                if (currentPage > 0) {
                    currentPage--;
                    let selectOrderDate1El = document.getElementsByClassName("select_date")[0];
                    let selectOrderDate2El = document.getElementsByClassName("select_date")[1];
                    let selectOrderDate1 = selectOrderDate1El.value || "";
                    let selectOrderDate2 = selectOrderDate2El.value || "";

                    // 依查詢條件載入訂單
                    init(currentPage, size, customerId, selectOrderDate1, selectOrderDate2);
                }
            });
        }
        //----------------------------------------------------------
        // btn 查詢
        const btnSelect = document.getElementById("select_btn");
        btnSelect.addEventListener("click", function (e) {
            e.preventDefault();
            let selectOrderDate1El = document.getElementsByClassName("select_date")[0];
            let selectOrderDate2El = document.getElementsByClassName("select_date")[1];
            let selectOrderDate1 = selectOrderDate1El.value || "";
            let selectOrderDate2 = selectOrderDate2El.value || "";

            // 依查詢條件載入訂單
            init(currentPage, size, customerId, selectOrderDate1, selectOrderDate2);
        });
    });
    //-----------------------------------------------------------------------
    function init(page, size, customerId, dateStart = "", dateEnd = "") {
        if (customerId) {
            let url = `/order/member/${customerId}?page=${page}&size=${size}`;
            if (dateStart && dateEnd) {
                url += `&dateStart=${encodeURIComponent(dateStart)}&dateEnd=${encodeURIComponent(dateEnd)}`;
                dateRangeApplied = true;  // 已選擇日期範圍
            } else {
                dateRangeApplied = false; // 未選擇日期範圍
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // console.log(data)
                    totalPages = data.totalPages; // 更新總頁數
                    updatePagination();           // 更新分頁按鈕狀態
                    showDB(data);                 // 顯示資料
                })
                .catch((error) => {
                    console.log("data 錯誤原因：" + error);
                });
        }
    }
    //-----------------------------------------------------------------------
    // 訂單列表
    function showDB(data){
        let orderHtml = "";
        let orderDtos = data.content; // 取得所有訂單

        // 訂單排序從新到舊
        for(let i =  0; i < orderDtos.length; i++) {
            const orderDto = orderDtos[i];
            // 檢查 orderDto 和 orders 是否存在
            if (orderDto && orderDto.orders) {
                // 訂單狀態不同 更改不同顏色
                let statusClass = "";
                switch (statusText(orderDto.orders.orderStatus)) {
                    case "訂單成立":
                    case "正在外送":
                    case "準備完成":
                        statusClass = "incomplete";  // 橘色
                        break;
                    case "訂單完成":
                        statusClass = "complete";  // 藍色
                        break;
                    case "訂單不成立":
                        statusClass = "cancel";  // 藍色
                        break;
                }

                // 有爭議訂單時，則顯示爭議狀態文字
                let disputeTextHtml = `<span class="dispute_text" id="dispute_status"> - </span>`;
                if (orderDto.disputeOrder) {
                    let dataDisputeStatus = orderDto.disputeOrder.disputeStatus;
                    if (dataDisputeStatus === 1) {
                        disputeTextHtml = `
                            <span class="dispute_text" id="dispute_status">爭議狀態： ${disputeStatusText(dataDisputeStatus)}</span>
                        `;
                    } else if (dataDisputeStatus === 2) {
                        disputeTextHtml = `
                            <span class="dispute_text" id="dispute_status">爭議狀態： ${disputeStatusText(dataDisputeStatus)}</span>
                            <span class="dispute_text"> / 退款金額：${orderDto.disputeOrder.refundAmount}元 </span>
                        `;
                    } else if (dataDisputeStatus === 3) {
                        disputeTextHtml = `
                            <span class="dispute_text" id="dispute_status">爭議狀態： ${disputeStatusText(dataDisputeStatus)}</span>
                            <span class="dispute_text"> / 原因：${orderDto.disputeOrder.rejectReason} </span>
                        `;
                    }
                }

                orderHtml += `
                    <li class="product-item  col-lg-4 col-md-6 col-sm-6 col-xs-6 col-ts-12 style-1">
                        <a href="./orderDetail.html?orderId=${orderDto.orders.orderId}">
                            <div class="product-inner equal-element">
                                <div class="product-thumb">
                                    <div class="thumb-inner" >
                                        <div>
                                            <div class="one_order_status ${statusClass}">
                                                <span class="one_order_status_text">${statusText(orderDto.orders.orderStatus)}</span>
                                            </div>
                                            <div class="one_order_list">
                                                <div class="one_order_list_circle">
                                                    <img class="store_logo" src="data:${orderDto.orders.store.contentType};base64,${orderDto.orders.store.logo}"alt="店家logo">
                                                </div>
                                                <div class="one_order_store_name">
                                                    <span>${orderDto.orders.store.storeName}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="product-info">
                                    <div class="group-info">
                                        <div class="order_id">
                                            <span>${orderDto.orders.orderId}</span>
                                        </div>
                                        <div class="order_detail">
                                            <span>${orderDto.orders.orderProductQuantity} 項商品</span>
                                        </div>
                                        <div class="order_price">
                                            <span>共 ${orderDto.orders.productAmount} 元</span>
                                        </div>
                                        <div class="order_time">
                                            <span class="order_date_value">${orderDto.orders.orderCreateDatetime}</span>
                                        </div>
                                        <div class="order_time dispute_status_div "> ${disputeTextHtml} </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </li>
                `;
            }
            document.getElementsByClassName("order_list_ul")[0].innerHTML = orderHtml;
        }
    }
    //-----------------------------------------------------------------------
    function updatePagination() {
        const previousButton = document.getElementById("previous");
        const nextButton = document.getElementById("next");
        const pagination = document.getElementById("pagination");

        if (previousButton) {
            previousButton.disabled = (currentPage === 0);
        }
        if (nextButton) {
            nextButton.disabled = (currentPage >= totalPages - 1);
        }

        // 只顯示5頁的按鈕
        let startPage = Math.max(0, currentPage - 2);
        let endPage = Math.min(totalPages - 1, currentPage + 4);

        let pageButtons = "";
        for (let i = startPage; i <= endPage; i++) {
            pageButtons += `<button class="page-button" data-page="${i}" ${i === currentPage ? 'disabled' : ''}>${i + 1}</button>`;
        }

        // 更新頁數按鈕和頁數顯示
        pagination.innerHTML = `
            <div>${pageButtons}</div>
            <div id="page_text">第 ${currentPage + 1} 頁 / 共 ${totalPages} 頁</div>
        `;
        const pageButtonsElements = document.querySelectorAll(".page-button");
        pageButtonsElements.forEach(button => {
            button.addEventListener("click", function () {
                currentPage = parseInt(this.getAttribute("data-page"), 10);

                let selectOrderDate1El = document.getElementsByClassName("select_date")[0];
                let selectOrderDate2El = document.getElementsByClassName("select_date")[1];
                let selectOrderDate1 = selectOrderDate1El.value || "";
                let selectOrderDate2 = selectOrderDate2El.value || "";

                // 依查詢條件載入訂單
                init(currentPage, size, customerId, selectOrderDate1, selectOrderDate2);
            });
        });
    }
    //-----------------------------------------------------------------------
    function statusText(statusNum) {
        switch (statusNum) {
            case 1 : return "訂單成立";
            case 2 : return "準備完成";
            case 3 : return "正在外送";
            case 4 : return "訂單完成";
            case 5 : return "訂單不成立";
        }
    }
    function disputeStatusText(statusNum) {
        switch (statusNum) {
            case 1 : return "申請爭議";
            case 2 : return "同意爭議";
            case 3 : return "取消爭議";
        }
    }
    //-----------------------------------------------------------------------
</script>
</body>
</html>