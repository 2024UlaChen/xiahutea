<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>後台 | 訂單管理</title>

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">

  <style>

      /* 查詢欄   */
      div.dataTables_filter label {
          font-weight: normal;
      }

      [type=search] {
          outline-offset: 0;
      }

      input.select_order {
          display: inline-block;
          border: 1px #C0C0C0 solid;
          margin-left: 5px;
          width: 220px;
          height: 30px;
          margin-right: 20px;
          border-radius: 4px;
      }

      select#select_status {
          display: inline-block;
          border: 1px #C0C0C0 solid;
          margin-left: 2px;
          width: 220px;
          height: 30px;
          text-align: center;
          border-radius: 4px;
      }

      input.select_date {
          display: inline-block;
          border: 1px #C0C0C0 solid;
          margin-left: 5px;
          width: 220px;
          height: 30px;
          margin-right: 10px;
          text-align: center;
          border-radius: 4px;
      }

      /* btn 查詢*/
      .btn-default {
          background-color: #F8F9FA;
          float: right;
      }

      .btn-block {
          width: 100px;
          height: 35px;
          font-weight: bolder;
      }

      /*分頁*/
      #page_div {
          display: flex; /* 使用 flexbox */
          justify-content: center; /* 水平置中 */
          gap: 20px; /* 按鈕之間的間距 */
      }
      .page_btn {
          margin-top: 8px;
      }
      .page-button {
          border: 1px #C0C0C0 solid;
          width: 30px;
          height: 35px;
          text-align: center;
          border-radius: 4px;
      }
      #page_text{
          text-align: center;
      }

      /*  訂單列表  */
      #order_thread, #order_tbody {
          text-align: center;
      }
  </style>
</head>

<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <div class="storeheader"></div>
  <div class="storeaside"></div>
  <!--/.header & aside -->

  <!-- 功能區塊    -->
  <div class="content-wrapper">
    <!--訂單區塊內的header-->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>訂單管理</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">訂單管理</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <!-- Main content-->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">訂單列表</h3>
              </div>
              <div class="card-body">
                <!-- 查詢欄位 -->
                <div class="dataTables_filter">
                  <label>
                    訂單編號<input type="search" class="select_order">
                  </label>
                  <label>
                    會員姓名<input type="search" class="select_order">
                  </label>
                  <label>
                    店家名稱<input type="search" class="select_order">
                  </label>
                  <label>
                    訂單狀態
                    <select id="select_status">
                      <option class="select_status_op" value="">請選擇</option>
                      <option class="select_status_op" value="訂單成立">訂單成立</option>
                      <option class="select_status_op" value="準備完成">準備完成</option>
                      <option class="select_status_op" value="正在外送">正在外送</option>
                      <option class="select_status_op" value="訂單完成">訂單完成</option>
                    </select>
                  </label>
                  <br>
                  <label>
                    訂單日期<input type="date" class="select_date">
                  </label>
                  <span>~</span>
                  <label>
                    訂單日期<input type="date" class="select_date">
                  </label>
                  <button id="btn_select" class="btn btn-block btn-default">查詢</button>
                </div>
                <!-- /.查詢欄位 -->

                <!-- 訂單列表   -->
                <table id="example1" class="table table-bordered table-striped">
                  <thead id="order_thread">
                  <tr>
                    <th>訂單日期</th>
                    <th>訂單編號</th>
                    <th>會員姓名</th>
                    <th>訂單狀態</th>
                    <th>店家名稱</th>
                    <th>商品數量</th>
                  </tr>
                  </thead>
                  <tbody id="order_tbody">
                  <!-- 列表放JS    -->
                  </tbody>
                </table>
                <!--/.訂單列表    -->
                <div id="page_div">
                  <button id="previous" class="btn btn-block btn-default page_btn">上一頁</button>
                  <span id="pagination" class="page_btn"></span>
                  <button id="next" class="btn btn-block btn-default page_btn">下一頁</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- /.Main content -->
  </div>
  <!-- /.功能區塊    -->
  <div class="storefooter"></div>
</div>

<script src="plugins/jquery/jquery.min.js"></script>
<script src="js/storegeneral.js"></script>
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<script src="plugins/datatables/jquery.dataTables.min.js"></script>
<script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="dist/js/adminlte.js"></script>
<script src="dist/js/demo.js"></script>

<script>

    let currentPage = 0; // 當前頁數
    let totalPages = 0; // 總頁數
    const size = 10; // 每頁顯示的筆數

    document.addEventListener("DOMContentLoaded", function () {
        // todo 權限判斷

        // 判斷權限
        fetch(`/totalusers`)
            .then(resp => resp.json())
            .then(totalUserDTO => {
                console.log(totalUserDTO)
                console.log(totalUserDTO.userTypeId)
                if(totalUserDTO.userTypeId !== 1 && totalUserDTO.userTypeId !== 3){
                    Swal.fire({
                        title: "權限不足",
                        text: '',
                        icon: 'error',
                        showConfirmButton: true  // 確認按鈕
                    }).then(() => {
                        location.href = "./storeOrderList.html";
                    });
                }
                // 如果是店家&管理員才能檢視
                init();
            })
            .catch((error) => {
                console.log("錯誤原因:" + error);
            });
        //===========================================================================

        // 顯示列表資料
        init(currentPage, size);

        // 確保元素存在 添加事件監聽器
        const nextButton = document.getElementById("next");
        const previousButton = document.getElementById("previous");

        if (nextButton) {
            nextButton.addEventListener("click", function () {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    init(currentPage, size); // 重新載入下一頁資料
                }
            });
        }
        if (previousButton) {
            previousButton.addEventListener("click", function () {
                if (currentPage > 0) {
                    currentPage--;
                    init(currentPage, size); // 重新載入上一頁資料
                }
            });
        }
    });

    // 顯示 明細
    function init(page, size) {
        fetch(`/order/manage?page=${page}&size=${size}`)
            .then(response => response.json())
            .then(data => {
                showAllDB(data); // 顯示資料
                totalPages = data.totalPages; // 更新總頁數
                updatePagination(); // 更新分頁按鈕狀態
            })
            .catch((error) => {
                console.log("錯誤原因：" + error);
            });
    }
    function showAllDB(data) {
        let orderHtml = "";
        let orders = data.content; // 取得所有訂單

        for (let i =  0; i < orders.length  ; i++) {
            const order = orders[i];
            orderHtml += `
                <tr>
                    <td class="order_date_value">${order.orderCreateDatetime}</td>
                    <td class="order_id_value"><a href="./storeOrderDetail.html?orderId=${order.orderId}">${order.orderId}</a></td>
                    <td class="order_username_value">${order.customer.nickname}</td>
                    <td class="order_status_value">${statusText(order.orderStatus)}</td>
                    <td class="order_store_value">${order.store.storeName}</td>
                    <td>${order.orderProductQuantity}</td>
                </tr>
            `;
        }
        document.getElementById("order_tbody").innerHTML = orderHtml;
    }

    function statusText(statusNum) {
        switch (statusNum) {
            case 1 :
                return "訂單成立";
            case 2 :
                return "準備完成";
            case 3 :
                return "正在外送";
            case 4 :
                return "訂單完成";
        }
    }

    function updatePagination() {
        const previousButton = document.getElementById("previous");
        const nextButton = document.getElementById("next");
        const pagination = document.getElementById("pagination");

        if (previousButton) {
            previousButton.disabled = (currentPage === 0);
        }
        if (nextButton) {
            nextButton.disabled = (currentPage >= totalPages - 1);
        }

        // 只顯示5頁的按鈕
        let startPage = Math.max(0, currentPage - 2);
        let endPage = Math.min(totalPages - 1, currentPage + 4);

        let pageButtons = "";
        for (let i = startPage; i <= endPage; i++) {
            pageButtons += `<button class="page-button" data-page="${i}" ${i === currentPage ? 'disabled' : ''}>${i + 1}</button>`;
        }

        // 更新頁碼按鈕和頁碼顯示
        pagination.innerHTML = `
            <div>${pageButtons}</div>
            <div id="page_text">第 ${currentPage + 1} 頁 / 共 ${totalPages} 頁</div>
        `;
        const pageButtonsElements = document.querySelectorAll(".page-button");
        pageButtonsElements.forEach(button => {
            button.addEventListener("click", function () {
                currentPage = parseInt(this.getAttribute("data-page"), 10);
                init(currentPage, size); // 重新載入資料
            });
        });
    }

    //----------------------------------------------------------
    // 1.查詢欄
    // 1.1 輸入查詢相關欄位，點查詢btn可篩選訂單
    let btn_select = document.getElementById("btn_select");
    btn_select.addEventListener("click", function () {

        let select_order_id = document.getElementsByClassName("select_order")[0]?.value.toLowerCase() || "";
        let select_order_user = document.getElementsByClassName("select_order")[1]?.value.toLowerCase() || "";
        let select_order_store = document.getElementsByClassName("select_order")[2]?.value.toLowerCase() || "";
        let select_order_status = document.getElementById("select_status").value || "";
        let select_order_date1 = document.getElementsByClassName("select_date")[0]?.value || "";
        let select_order_date2 = document.getElementsByClassName("select_date")[1]?.value || "";

        let order_rows = document.querySelectorAll("tbody tr");
        order_rows.forEach(row => {

            let order_id_el = row.getElementsByClassName("order_id_value")[0];
            let order_user_el = row.getElementsByClassName("order_username_value")[0];
            let order_store_el = row.getElementsByClassName("order_store_value")[0];
            let order_status_el = row.getElementsByClassName("order_status_value")[0];
            let order_date_el = row.getElementsByClassName("order_date_value")[0];

            if (!order_id_el || !order_user_el || !order_store_el || !order_status_el || !order_date_el) {
                return; // 跳過此列
            }
            // 取得訂單列表資料
            let order_id = order_id_el.innerText.trim().toLowerCase();
            let order_user = order_user_el.innerText.trim().toLowerCase();
            let order_store = order_store_el.innerText.trim().toLowerCase();
            let order_status = order_status_el.innerText.trim();
            let order_date = order_date_el.innerText.trim();

            let show_row = true;

            // 篩選條件
            if (select_order_id && !order_id.includes(select_order_id)) {
                show_row = false;
            }
            if (select_order_user && !order_user.includes(select_order_user)) {
                show_row = false;
            }
            if (select_order_store && !order_store.includes(select_order_store)) {
                show_row = false;
            }
            if (select_order_status && order_status !== select_order_status) {
                show_row = false;
            }

            if (select_order_date1 && select_order_date2) {
                let order_date_obj = new Date(order_date);
                let date1 = new Date(select_order_date1);
                let date2 = new Date(select_order_date2);
                // 設定 date1 和 date2 的時間範圍
                date1.setHours(0, 0, 0, 0); // 9/22 00:00
                date2.setHours(23, 59, 59, 999); // 9/22 23:59

                if (order_date_obj < date1 || order_date_obj > date2) {
                    show_row = false;
                }
            }
            // 顯示或隱藏該列
            row.style.display = show_row ? "" : "none";
        });
    });

</script>
</body>
</html>