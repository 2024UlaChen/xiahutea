<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>店家基本資料維護</title>

    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <div class="storeheader"></div>
      <!-- /.navbar -->
      <div class="storeaside"></div>

      <div style="margin: auto; max-width: 60%">
        <h1 class="text-center">店家基本資料設定</h1>
        <div class="container m-5 shadow-lg p-3 mb-5 bg-body rounded">
          <form>
            <div class="m-3">
              <label for="帳號(統編)" class="form-label">帳號</label>
              <input
                readonly
                type="text"
                class="form-control"
                id="vat"
                value="12345678"
                aria-describedby="emailHelp"
              />
            </div>

            <div class="m-3">
              <label class="form-label">商店名稱</label>
              <input
                readonly
                type="text"
                class="form-control"
                value="五十花"
                id="storename"
              />
            </div>
            <div class="m-3">
              <label class="form-label">註冊日</label>
              <input
                readonly
                type="date"
                class="form-control"
                value="2024-07-17"
                id="registerday"
              />
            </div>
            <div class="m-3">
              <label class="form-label">商店地址</label>
              <input
                readonly
                type="text"
                class="form-control"
                value="台中101大樓"
                id="storeaddress"
              />
            </div>
            <div class="m-3">
              <label class="form-label">商店電話</label>
              <input
                      required
                id="storephone"
                type="text"
                class="form-control"
                value="0123456789"
              />
            </div>
            <div class="m-3">
              <label class="form-label">開始營業時間</label>
              <input
                      required
                type="time"
                class="form-control"
                value="10:00"
                id="openingtime"
              />
            </div>
            <div class="m-3">
              <label class="form-label">結束營業時間</label>
              <input
                      required
                type="time"
                class="form-control"
                value="22:00"
                id="closingtime"
              />
            </div>
            <div class="m-3">
              <label class="form-label">公休日</label>
              <input type="date" class="form-control" value="" id="holiday" />
              <div class="form-text">需要店休再設定即可</div>
            </div>
            <div class="m-3 form-check">
              <input
                type="checkbox"
                class="form-check-input"
                id="istakeorders"
              />
              <label class="form-check-label">是否接受訂單</label>
            </div>
            <div class="m-3 form-check">
              <input type="checkbox" class="form-check-input" id="isdelivery" />
              <label class="form-check-label">是否外送</label>
            </div>
            <div class="m-3 input-group">
              <label class="input-group">外送門檻金額</label>
              <span class="input-group-text">NTD(新台幣)</span>
              <input
                type="text"
                class="input-group form-control"
                style="margin-right: 30px"

                id="deliverymoney"
              />
            </div>
            <div class="m-3">
              <label class="form-label">外送距離限制</label>

              <select
                class="form-select form-select-"
                aria-label=".form-select-sm example"
                id="distance"
              >
                <option value="1">1公里</option>
                <option value="2">2公里</option>
                <option value="3">3公里</option>
                <option value="0">暫不提供外送服務</option>
              </select>
            </div>
            <div class="m-3">
              <label class="form-label">商標</label>
              <input type="file" name="img" id="newLogo"  />

              <img src="" id="storeimg" height="200px" width="200px" >
            </div>



            <div class="m-3">
              <label class="form-label">信箱</label>
              <input
                      required
                type="email"
                class="form-control"
                id="mail"
                value="name@example.com"
              />
            </div>
            <div class="m-3">
              <label class="form-label">聯絡人</label>
              <input
                      required
                type="text"
                class="form-control"
                value="李登輝"
                id="contactperson"
              />
            </div>
            <div class="m-3">
              <label class="form-label">聯絡人電話</label>
              <input
                      required
                type="text"
                class="form-control"
                value="911"
                id="contactphone"
              />
            </div>

            <div class="row">
              <div class="col-2"></div>
              <div class="col-8">
                <a
                  id="storePassWordTag"
                  href="storeInfoEditPassword.html"
                  class="btn btn-primary m-3"
                  >修改密碼</a
                >
                <a
                  id="storeLoyaltyCardTag"
                  href="storeInfoEditLoyaltyCard.html"
                  class="btn btn-primary m-3"
                  >設定集點卡</a
                >
                <a
                  id="storeInfoTag"
                  href="#storeInfo.html"
                  class="btn btn-primary m-3"
                  >返回</a
                >
                <button type="submit" class="btn btn-primary m-3" id="savebtn">
                  儲存
                </button>
              </div>
              <div class="col-2"></div>
            </div>
          </form>
          <form
            action="/store/upload"
            method="POST"
            enctype="multipart/form-data"
          >


          </form>
        </div>
      </div>

      <!-- /.control-sidebar -->
      <div class="storefooter"></div>
    </div>
    <!-- ./wrapper -->

    <!-- jQuery -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <script src="js/storegeneral.js"></script>
    <!-- Bootstrap 4 -->
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="dist/js/demo.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <!--sweetalert2-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let sotreid = location.search.split("?")[1];
        let infoUrlstr = `storeinfo.html?${sotreid}`;
        let loyaltyCardUrlstr = `storeInfoEditLoyaltyCard.html?${sotreid}`;
        let passWordUrlstr = `storeInfoEditPassword.html?${sotreid}`;
        document.querySelector("#storeInfoTag").href = infoUrlstr;
        document.querySelector("#storeLoyaltyCardTag").href = loyaltyCardUrlstr;
        document.querySelector("#storePassWordTag").href = passWordUrlstr;

        //欄位宣告
        let vat = document.querySelector("#vat");
        let storename = document.querySelector("#storename");

        let registerday = document.querySelector("#registerday");

        let storeaddress = document.querySelector("#storeaddress");

        let storephone = document.querySelector("#storephone");

        let openingtime = document.querySelector("#openingtime");

        let closingtime = document.querySelector("#closingtime");

        let holiday = document.querySelector("#holiday"); //打向其他api

        let istakeorders = document.querySelector("#istakeorders");

        let isdelivery = document.querySelector("#isdelivery");

        let deliverymoney = document.querySelector("#deliverymoney");

        let distance = document.querySelector("#distance");

        let newLogoImg = document.querySelector('#newLogo');

        let mail = document.querySelector("#mail");

        let contactperson = document.querySelector("#contactperson");

        let contactphone = document.querySelector("#contactphone");

        let IsStopAction = false;


        $.ajax({
          url: `/store/storeinfo/${sotreid.split("=")[1]}`,
          method: "get",
          dataType: "json",
          async: false,
          success: function (data) {
            if(!data.successful){
              //登入失敗
              location.href = "./backstageLogin.html";
            }
            fetch("/store/GetLoginType").then(data => data.json()).then(
                    res => {
                      if(res.userTypeId !== 3){

                        document.querySelector('#storeListAsideLink').classList.add("d-none");
                      }


                      document.querySelector("#storeInfoAsideLink").href= `storeInfo.html?storeid=${sotreid.split("=")[1]}`;
                      document.querySelector("#storeLoyaltyCardAsideLink").href=`storeInfoEditLoyaltyCard.html?storeid=${sotreid.split("=")[1]}`;
                      document.querySelector("#storePasswordAsideLink").href=`storeInfoEditPassword.html?storeid=${sotreid.split("=")[1]}`;
                    }
            );
            console.log(data);
            vat.value = data.vat;
            storename.value = data.storeName;
            registerday.value = data.registerDay.split("T")[0];
            storeaddress.value = data.storeAddress;
            storephone.value = data.storePhone;
            openingtime.value = data.openingHours;
            closingtime.value = data.closingHours;
            const base64Img = data.logo;
            storeImage = document.querySelector('#storeimg');




            storeImage.src = `data:image/png;base64,${base64Img}`;



            if (data.isTakeOrders) {
              istakeorders.checked = true;
            }
            if (data.isDelivery) {
              isdelivery.checked = true;
            }



            deliverymoney.value = data.deliveryMoney;
            distance.value = data.deliveryDistance;
            mail.value = data.email;
            contactperson.value = data.contactPerson;
            contactphone.value = data.contactPhone;
          },
          err: function () {
            Swal.fire({
              icon: "error",
              title: "讀取失敗",
            });
          },
        }); //讀取store

        document
          .querySelector("#savebtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            //商phone
            storephone = document.querySelector("#storephone").value;
            if(storephone ===""){
              IsStopAction = true;
              Swal.fire({
                text: "請輸入商家電話",
                icon:"warning"
              });
              return;
            }

            openingtime = document.querySelector("#openingtime").value;
            if(openingtime ===""){
              IsStopAction = true;
              Swal.fire({
                text: "請輸入開店時間",
                icon:"warning"
              });
              return;
            }
            console.log(openingtime);
            console.log(openingtime + ":00");

            closingtime = document.querySelector("#closingtime").value;
            if(closingtime ===""){
              IsStopAction = true;
              Swal.fire({
                text: "請輸入關店時間",
                icon:"warning"
              });
              return;
            }

            holiday = document.querySelector("#holiday").value;


            istakeorders = document.querySelector("#istakeorders").checked
              ? true
              : false;

            isdelivery = document.querySelector("#isdelivery").checked
              ? true
              : false;
            deliverymoney = document.querySelector("#deliverymoney").value;
            console.log("瞧瞧");
            console.log(deliverymoney);
            //檢查如果有外送 必須要有外送金
            if(isdelivery){
              if(deliverymoney === ""){
                Swal.fire({
                  icon:"warning",
                  text:"當提供外送服務，需要輸入外送門檻額度"
                });
                IsStopAction = true;
              }

            }



            distance = document.querySelector("#distance").value;


            mail = document.querySelector("#mail").value;
            if(mail ===""){
              IsStopAction = true;
              Swal.fire({
                text: "信箱不能為空",
                icon:"warning"
              });
              return;
            }


            contactperson = document.querySelector("#contactperson").value;
            if(contactperson ===""){
              IsStopAction = true;
              Swal.fire({
                text: "聯絡人不能為空",
                icon:"warning"
              });
              return;
            }

            contactphone = document.querySelector("#contactphone").value;
            if(contactphone ===""){
              IsStopAction = true;
              Swal.fire({
                text: "聯絡人電話不能為空",
                icon:"warning"
              });
              return;
            }

            let id = sotreid.split("=")[1];
            let model = {
              storeId: id,
              storePhone: storephone,
              openingHours:
                countStr(openingtime) == 2 ? openingtime : openingtime + ":00",
              closingHours:
                countStr(closingtime) == 2 ? closingtime : closingtime + ":00",
              isDelivery: isdelivery,
              deliveryDistance: distance,
              deliveryMoney: deliverymoney,
              isTakeOrders: istakeorders,
              email: mail,
              contactPerson: contactperson,
              contactPhone: contactphone,
            };
            //檢查


            if(!IsStopAction){
              $.ajax({
                url: "/store/editstoreinfo",
                method: "POST",
                contentType: "application/json",
                dataType: "JSON",
                data: JSON.stringify(model),
                success: function (data) {
                  console.log(JSON.stringify(model));
                  //接著處理照片
                  if(newLogoImg.files.length> 0){
                    console.log("進到if內了");
                    let formData = new FormData();
                    formData.append('storeId',data.storeId);
                    formData.append('img',newLogoImg.files[0]);
                    fetch('/store/uploadLogo',{
                      method:'POST',
                      body:formData
                    }).then(resp =>{
                      Swal.fire({
                        icon: "success",
                        title: "更新成功",
                      }).then((res) => {
                        if (res.isConfirmed) {
                          location.reload();
                        }
                      });
                    });
                  }else {
                    Swal.fire({
                      icon: "success",
                      title: "更新成功",
                    }).then((res) => {
                      if (res.isConfirmed) {
                        location.reload();
                      }
                    });
                  }


                },
                err: function () {
                  Swal.fire({
                    icon: "error",
                    title: "更新失敗",
                  });
                },
              }); //編輯會員
            }
            IsStopAction = false;


          }); //監聽save 但不需要提交 所以阻擋預設行為
      }); //DOM END

      function countStr(str) {
        // 根據冒號分割字串
        const parts = str.split(":");
        // 冒號的出現次數等於分割後的數組長度減去 1
        return parts.length - 1;
      }
    </script>
  </body>
</html>
