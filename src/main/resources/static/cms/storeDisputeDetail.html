<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>後台 | 訂單爭議明細</title>

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
    <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <!-- SweetAlert2 CSS樣式 -->
    <link rel="stylesheet" href="/cms/plugins/sweetalert2/sweetalert2.css">

    <style>
        /* 左右main區塊  */
        @media (min-width: 768px) {
            .col-md-6 {
                flex: 0 0 0;
                max-width: 55%;
            }
            .left-main{
                flex: 0 0 55%;

            }
            .right-main{
                flex: 0 0 45%;
            }
        }

        /* 表格區塊 */
        .table{
            text-align:center;
            table-layout: fixed;
        }
        .table th{
            width:20%;
        }
        .table td{
            width:calc(100% - 20%);
        }
        .tfoot th{
            text-align: right;
        }
        .table_info tr{
            text-align: left;
        }
        .card-body.p-0 .table tbody>tr>td:last-of-type, .card-body.p-0 .table tbody>tr>th:last-of-type, .card-body.p-0 .table tfoot>tr>td:last-of-type, .card-body.p-0 .table tfoot>tr>th:last-of-type, .card-body.p-0 .table thead>tr>td:last-of-type, .card-body.p-0 .table thead>tr>th:last-of-type{
            padding-right: 1px;
            padding-left: 1.5rem;
        }
        /* btn */
        button.card-btn{
            float: right; /* 將按鈕浮動到右邊 */
            margin-left: 10px; /* 可以調整按鈕之間的間距 */
        }
        /* btn 上一頁*/
        .btn-default {
            background-color: #F8F9FA;
        }
        .btn-block {
            width: 100px;
            font-weight: bolder;
        }
        /* btn 儲存*/
        .btn-block+.btn-block {
            margin-top: 0;
        }
        .btn-info {
            background-color: #73B4BA;
            border-color: #73B4BA;
        }
        /* input */
        input#dispute_money , #select_status{
            width: 90%;
            border-radius: 4px;
            font-weight: 400;
            vertical-align:center;
        }
        .input_text{
            width: 90%;
            max-height: 80px;
            min-height: 80px;
            border-radius: 4px;
        }
        .input_lab{
            width: 100%;
            height: 50%;
        }

        /* 必填* */
        .red_star{
            color: red;
        }
    </style>
</head>

<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <!--header & aside -->
        <div class="storeheader"></div>
        <div class="storeaside"></div>
        <!--/.header & aside -->
        <!-- main    -->
        <div class="content-wrapper">
            <!-- 功能 Header    -->
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>訂單爭議明細</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active">訂單爭議明細</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>
            <!-- /.功能 Header -->
            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <!--     左區塊             -->
                        <div class="col-md-6 left-main">
                            <!--     訂單資訊 區塊       -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">訂單資訊</div>
                                    <button class="card-btn btn btn-block btn-default" id="btn_dispute_back">回上一頁</button>
                                    <button class="card-btn btn_dispute_save btn btn-block btn-info" id="demo1" >儲存</button>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm" style="text-align:center;table-layout: fixed">
                                        <thead>
                                            <tr>
                                                <th>爭議編號</th>
                                                <th>訂單編號</th>
                                                <th>會員編號</th>
                                                <th>會員姓名</th>
                                                <th>店家名稱</th>
                                                <th>爭議狀態</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detail_tbody">
                                        <!-- JS         -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!--   /.訂單資訊 區塊       -->
                            <!--     商品資訊 區塊       -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">商品資訊</h3>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>商品</th>
                                                <th>甜度 / 溫度</th>
                                                <th>加料</th>
                                                <th>數量</th>
                                                <th>商品小計</th>
                                            </tr>
                                        </thead>
                                        <tbody id="product_tbody">

                                        <!--  JS                    -->
                                        </tbody>
                                        <tfoot class="tfoot" id="product_tfoot">
                                        <!--   JS             -->
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <!-- /.商品資訊 區塊 -->
                        </div>
                        <!-- /.左區塊 -->
                        <!--     右區塊             -->
                        <div class="col-md-6 right-main">
                            <!--     爭議資訊 區塊       -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">爭議資訊</h3>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table">
                                        <tbody class="table_info" id="dispute_tbody">
                                        <tr>
                                            <th>申請日期</th>
                                            <td>2024/07/26 20:40</td>
                                        </tr>
                                        <tr>
                                            <th>爭議原因</th>
                                            <td>珍珠奶茶裡 沒有珍珠</td>
                                        </tr>
                                        <tr>
                                            <th>處理狀態</th>
                                            <td>
                                                <label class="input_lab">
                                                    <select id="select_status">
                                                        <option value="1" selected>未處理</option>
                                                        <option value="2">同意</option>
                                                        <option value="3">不同意</option>
                                                    </select>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>退款金額<span class="red_star">*</span></th>
                                            <td>
                                                <label class="input_lab">
                                                    <input id="dispute_money" type="text" disabled>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>不同意原因<span class="red_star">*</span></th>
                                            <td>
                                                <label class="input_lab">
                                                    <textarea class="input_text" disabled></textarea>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>內部備註</th>
                                            <td>
                                                <label class="input_lab">
                                                    <textarea class="input_text"></textarea>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>更新日期</th>
                                            <td>2024/07/27 16:33</td>
                                        </tr>
                                        <!--   JS       -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!--   /.爭議資訊 區塊       -->
                        </div>
                    </div>
                </div>
            </section>
            <!-- /.Main content -->
        </div>

        <div class="storefooter"></div>
    </div>

    <script src="plugins/jquery/jquery.min.js"></script>
    <script src="js/storegeneral.js"></script>
    <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
    <script src="plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="dist/js/adminlte.js"></script>
    <script src="dist/js/demo.js"></script>
    <!-- sweet alert  -->
    <script src="./plugins/sweetalert2/sweetalert2.all.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {

            // 0. 顯示明細
            init();

            function init(){
                let orderId = getQueryParam("orderId");
                if (orderId) {
                    fetch(`/manage/${disputeOrderId}`)
                          .then(resp => resp.json())
                          .then(data => showDB(data))
                          .catch((error) => {
                              console.log("錯誤原因:" + error);
                          });
                }else {
                    console.error("訂單號碼錯誤");
                }
            }
            // 取得URL的查詢參數
            function getQueryParam(param) {
                let urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }
            // todo
            // 找明細
            function showDB() {
                let detailHtml = "";
                detailHtml = `
                        <tr>
                            <td id="dispute_id">${data[0].dispute.disputeId}</td>
                            <td id="order_id">${data[0].dispute.orderId}</td>
                            <td>${data[0].customer.customerRemark}</td>
                            <td>${data[0].customer.nickname}</td>
                            <td>${data[0].store.storeName}</td>
                            <td id="status_text">${statusText(data[0].dispute.disputeStatus)}</td>
                        </tr>
                `;
                document.getElementById("detail_tbody").innerHTML = detailHtml;

                let disputeHtml = "";

                document.getElementById("dispute_tbody").innerHTML = detailHtml;

                let productTfootHtml = "";
                productTfootHtml = `
                            <tr>
                                <td colspan="5"></td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">商品總金額</th>
                                <td>${data[0].orders.productAmount}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">平台處理費</th>
                                <td>${data[0].orders.processingFees}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">錢包折抵</th>
                                <td>- ${data[0].orders.customerMoneyDiscount}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">優惠券折抵</th>
                                <td>- ${data[0].orders.couponDiscount}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">集點折抵</th>
                                <td>- ${data[0].orders.loyaltyDiscount}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">付款金額</th>
                                <td>${data[0].orders.paymentAmount}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th colspan="3">付款方式</th>
                                <td>${paymentMethodText(data[0].orders.paymentMethod)}</td>
                            </tr>
                `;
                document.getElementById("product_tfoot").innerHTML = productTfootHtml;

                let productTbodyHtml = "";
                for (let i = 0; i < data.length; i++) {
                    productTbodyHtml += `
                        <tr>
                            <td>${data[i].product.productName} / ${productSizeText(data[i].product.size)}</td>
                            <td>${data[i].productSugar} / ${data[i].productTemperature}</td>
                            <td>${nullText(data[i].productAddMaterials)}</td>
                            <td>${data[i].productQuantity}</td>
                            <td>${data[i].productPrice}</td>
                        </tr>
                    `;
                }
                document.getElementById("product_tbody").innerHTML = productTbodyHtml;
            }


            let order_id = document.getElementById("order_id");
            let dispute_id = document.getElementById("dispute_id");
            let dispute_money = document.getElementById("dispute_money");
            let reject_reason = document.getElementsByClassName("input_text")[0];
            let dispute_notes = document.getElementsByClassName("input_text")[1];
            let dispute_status = document.getElementById("select_status");
            //===========================================================================

            //1. btn 回上一頁
            const btn_dispute_back = document.getElementById("btn_dispute_back");
            btn_dispute_back.addEventListener("click", function(){
                history.back();
            });

            // 2. select 判斷爭議狀態選單- 因狀態不同而顯示不同的輸入欄位
            dispute_status.addEventListener("change", function (){
               // 2.1 狀態為 同意時，不可輸入reject_reason，值需清空
                if(dispute_status.value === '2'){
                    console.log(dispute_status.value);
                    dispute_money.removeAttribute("disabled");
                    reject_reason.setAttribute("disabled", "disabled");
                    reject_reason.value = "";
                } else if(dispute_status.value === '3'){
                    // 2.2 狀態為 不同意時，不可輸入dispute_money，值需清空
                    console.log(dispute_status.value);
                    dispute_money.setAttribute("disabled", "disabled");
                    reject_reason.removeAttribute("disabled");
                    dispute_money.value = "";
                }else {
                    // 2.3 狀態為 未處理 ，不可輸入dispute_money & reject_reason，值需清空
                    dispute_money.setAttribute("disabled", "disabled");
                    reject_reason.setAttribute("disabled", "disabled");
                    dispute_money.value = "";
                    reject_reason.value = "";
                }
            });

            // 3. input 欄位 - dispute_money 判斷輸入金額範圍
            dispute_money.addEventListener("blur", function (){
                let payment_amount = parseInt(document.getElementById("payment_amount").innerText);
                let order_free_amount = parseInt(document.getElementById("order_free_amount").innerText);
                if(parseFloat(dispute_money.value) > payment_amount + order_free_amount || parseFloat(dispute_money.value) < 0 || dispute_money.value === "" ){
                    Swal.fire("退款金額輸入錯誤","","error");
                    dispute_money.value = 0;
                }
            });

            // 4. input 欄位 - reject_reason 判斷字數長度
            reject_reason.addEventListener("blur", function (){
                if(reject_reason.value.length < 1 ){
                    Swal.fire("請輸入不同意爭議原因","","error");
                }
            });
        //===========================================================================
            // todo: 點擊儲存btn 後端需儲存內容
            // 5. 更改內容後，點擊儲存btn 需儲存內容 並依狀態更改按鈕css
            const btn_dispute_save = document.getElementsByClassName("btn_dispute_save")[0];
            btn_dispute_save.addEventListener("click", function(){

                // 5.1 點擊btn 檢查必填欄位
                let check_valve = false;
                if (dispute_status.value === '1' ) {
                    check_valve = true;
                }else if (dispute_status.value === '2' && dispute_money.value.trim() !== "") {
                    check_valve = true;
                }else if (dispute_status.value === '3' && reject_reason.value.trim() !== "") {
                    check_valve = true;
                } else {
                    Swal.fire("請確認所有必填欄位已完成","","error");
                    return;
                }

                // 5.2 如果符合5.1檢查條件，執行打包資料
                if (check_valve) {
                    let order_data = new FormData();
                    order_data.append("order_id", order_id.innerText);
                    order_data.append("dispute_id", dispute_id.innerText);
                    order_data.append("dispute_money", dispute_money.value);
                    order_data.append("reject_reason", reject_reason.value);
                    order_data.append("dispute_notes", dispute_notes.value);
                    order_data.append("dispute_status", dispute_status.value);

                    //  todo: 待確認 url
                    fetch("https://jsonplaceholder.typicode.com/posts", {
                        method: "POST",
                        body: order_data
                    }).then(res => res.json()).then(data => {
                        // todo: 5.3 儲存內容到後端 前台需顯示更新後的內容


                        // 5.4 如果爭議狀態為已同意/不同意，鎖定-儲存btn&狀態選單
                        if(dispute_status.value === '3' || dispute_status.value === '2'){
                            btn_dispute_save.setAttribute("disabled", "disabled");
                            dispute_status.setAttribute("disabled", "disabled");
                            dispute_money.setAttribute("disabled", "disabled");
                            reject_reason.setAttribute("disabled", "disabled");
                        }
                        Swal.fire("已更新", "", "success");
                    }).catch((error) =>{
                        console.error("發生錯誤：", error);
                        Swal.fire("更新失敗","","error");
                    });
                }
            });
            //===========================================================================
        });
    </script>
</body>
</html>